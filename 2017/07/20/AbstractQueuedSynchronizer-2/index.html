<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="æ–‡ç« æ¯”è¾ƒé•¿ï¼Œä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®åœ¨ pc ä¸Šé˜…è¯»ã€‚æ–‡ç« æ ‡é¢˜æ˜¯ä¸ºäº†å‘¼åº”å‰æ–‡ï¼Œå…¶å®å¯ä»¥å•ç‹¬æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›è¯»è€…çœ‹æ–‡ç« èƒ½ç³»ç»Ÿçœ‹ã€‚å†™åˆ°åé¢ï¼Œæˆ‘éƒ½æƒ³ç»™è¿™ç¯‡æ–‡ç« å–å‡ ä¸ªå”¬äººçš„æ ‡é¢˜äº†ï¼Œå·®ç‚¹å˜æˆæ ‡é¢˜å…šï¼Œå¦‚ï¼š  æ·±å…¥ç†è§£ ReentrantLock å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ« æ·±å…¥åˆ†æ AbstractQueuedSynchronizer ä¸­çš„ ConditionObject æ·±å…¥ç†è§£ java çº¿ç¨‹ä¸­æ–­å’Œ Interr">
<meta property="og:type" content="article">
<meta property="og:title" content="ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (äºŒ)">
<meta property="og:url" content="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/index.html">
<meta property="og:site_name" content="Javaç†Š">
<meta property="og:description" content="æ–‡ç« æ¯”è¾ƒé•¿ï¼Œä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®åœ¨ pc ä¸Šé˜…è¯»ã€‚æ–‡ç« æ ‡é¢˜æ˜¯ä¸ºäº†å‘¼åº”å‰æ–‡ï¼Œå…¶å®å¯ä»¥å•ç‹¬æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›è¯»è€…çœ‹æ–‡ç« èƒ½ç³»ç»Ÿçœ‹ã€‚å†™åˆ°åé¢ï¼Œæˆ‘éƒ½æƒ³ç»™è¿™ç¯‡æ–‡ç« å–å‡ ä¸ªå”¬äººçš„æ ‡é¢˜äº†ï¼Œå·®ç‚¹å˜æˆæ ‡é¢˜å…šï¼Œå¦‚ï¼š  æ·±å…¥ç†è§£ ReentrantLock å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ« æ·±å…¥åˆ†æ AbstractQueuedSynchronizer ä¸­çš„ ConditionObject æ·±å…¥ç†è§£ java çº¿ç¨‹ä¸­æ–­å’Œ Interr">
<meta property="og:image" content="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/aqs2-1.png">
<meta property="og:image" content="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/aqs2-2.png">
<meta property="og:updated_time" content="2017-07-26T02:54:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (äºŒ)">
<meta name="twitter:description" content="æ–‡ç« æ¯”è¾ƒé•¿ï¼Œä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®åœ¨ pc ä¸Šé˜…è¯»ã€‚æ–‡ç« æ ‡é¢˜æ˜¯ä¸ºäº†å‘¼åº”å‰æ–‡ï¼Œå…¶å®å¯ä»¥å•ç‹¬æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›è¯»è€…çœ‹æ–‡ç« èƒ½ç³»ç»Ÿçœ‹ã€‚å†™åˆ°åé¢ï¼Œæˆ‘éƒ½æƒ³ç»™è¿™ç¯‡æ–‡ç« å–å‡ ä¸ªå”¬äººçš„æ ‡é¢˜äº†ï¼Œå·®ç‚¹å˜æˆæ ‡é¢˜å…šï¼Œå¦‚ï¼š  æ·±å…¥ç†è§£ ReentrantLock å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ« æ·±å…¥åˆ†æ AbstractQueuedSynchronizer ä¸­çš„ ConditionObject æ·±å…¥ç†è§£ java çº¿ç¨‹ä¸­æ–­å’Œ Interr">
<meta name="twitter:image" content="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/aqs2-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/"/>





  <title>ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (äºŒ) | Javaç†Š</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4b184c55e2404e189b57f75ab8ac7158";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Javaç†Š</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hong Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Javaç†Š">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (äºŒ)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2017-07-20T00:00:00+08:00">
                2017-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/concurrency/" itemprop="url" rel="index">
                    <span itemprop="name">concurrency</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/20/AbstractQueuedSynchronizer-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/20/AbstractQueuedSynchronizer-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>æ–‡ç« æ¯”è¾ƒé•¿ï¼Œä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œå»ºè®®åœ¨ pc ä¸Šé˜…è¯»ã€‚æ–‡ç« æ ‡é¢˜æ˜¯ä¸ºäº†å‘¼åº”å‰æ–‡ï¼Œå…¶å®å¯ä»¥å•ç‹¬æˆæ–‡çš„ï¼Œä¸»è¦æ˜¯å¸Œæœ›è¯»è€…çœ‹æ–‡ç« èƒ½ç³»ç»Ÿçœ‹ã€‚å†™åˆ°åé¢ï¼Œæˆ‘éƒ½æƒ³ç»™è¿™ç¯‡æ–‡ç« å–å‡ ä¸ªå”¬äººçš„æ ‡é¢˜äº†ï¼Œå·®ç‚¹å˜æˆæ ‡é¢˜å…šï¼Œå¦‚ï¼š</p>
<ol>
<li>æ·±å…¥ç†è§£ ReentrantLock å…¬å¹³é”å’Œéå…¬å¹³é”çš„åŒºåˆ«</li>
<li>æ·±å…¥åˆ†æ AbstractQueuedSynchronizer ä¸­çš„ ConditionObject</li>
<li>æ·±å…¥ç†è§£ java çº¿ç¨‹ä¸­æ–­å’Œ InterruptedException å¼‚å¸¸</li>
</ol>
<p>åŸºæœ¬ä¸Šæœ¬æ–‡æŠŠä»¥ä¸Šå‡ ç‚¹éƒ½è¯´æ¸…æ¥šäº†ï¼Œæˆ‘å‡è®¾è¯»è€…çœ‹è¿‡<a href="http://hongjiev.github.io/2017/06/16/AbstractQueuedSynchronizer/" target="_blank" rel="external">ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å¯¹ AbstractQueuedSynchronizer çš„ä»‹ç» </a>ï¼Œå½“ç„¶å¦‚æœä½ å·²ç»ç†Ÿæ‚‰ AQS ä¸­çš„ç‹¬å é”äº†ï¼Œé‚£ä¹Ÿå¯ä»¥ç›´æ¥çœ‹è¿™ç¯‡ã€‚å„å°èŠ‚ä¹‹é—´åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆå…³ç³»ï¼Œå¤§å®¶å¯ä»¥åªå…³æ³¨è‡ªå·±æ„Ÿå…´è¶£çš„éƒ¨åˆ†ã€‚</p>
<p>æˆ‘æƒ³å®ç°çš„ç›®æ ‡ï¼šå¸Œæœ›å¤§å®¶æƒ³çœ‹ java.util.concurrent.lock æºç åˆ†æçš„æ—¶å€™ï¼Œç›´æ¥çœ‹æˆ‘çš„è¿™ä¸¤ç¯‡æ–‡ç« å°±å¯ä»¥äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘å¯èƒ½è¿˜éœ€è¦å†™ç¬¬ä¸‰ç¯‡æ–‡ç« ï¼ŒæŠŠå…±äº«æ¨¡å¼è¯¦ç»†åˆ†æä¸‹ï¼Œç„¶åä»‹ç»è¿™ä¸ªåŒ…å‰©ä½™çš„å‡ ä¸ªç±»ï¼ŒåŒæ—¶æŠŠä¸åœ¨è¿™ä¸ªåŒ…é‡Œé¢çš„ CountDownLatchã€CyclicBarrierã€Semaphore ç­‰ç›¸å…³çš„ç±»ä¸²è®²ä¸€ä¸‹ã€‚è¿œæœŸç›®æ ‡æ˜¯æŠŠ concurrent åŒ…ä¸­çš„æ‰€æœ‰ç±»éƒ½ä»‹ç»å®Œï¼Œå¦‚æœç¡®å®šäº†ä¸ä¼šå®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä¼šå·å·æŠŠè¿™å¥è¯åˆ é™¤çš„ğŸ˜‚ã€‚</p>
<p><img src="/2017/07/20/AbstractQueuedSynchronizer-2/aqs2-1.png" alt="aqs2-1"></p>
<a id="more"></a>
<!-- toc -->
<ul>
<li><a href="#å…¬å¹³é”å’Œéå…¬å¹³é”">å…¬å¹³é”å’Œéå…¬å¹³é”</a></li>
<li><a href="#condition">Condition</a><ul>
<li><a href="#1-å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—">1. å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—</a></li>
<li><a href="#2-å®Œå…¨é‡Šæ”¾ç‹¬å é”">2. å®Œå…¨é‡Šæ”¾ç‹¬å é”</a></li>
<li><a href="#3-ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—">3. ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</a></li>
<li><a href="#4-signal-å”¤é†’çº¿ç¨‹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—">4. signal å”¤é†’çº¿ç¨‹ï¼Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</a></li>
<li><a href="#5-å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€">5. å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€</a></li>
<li><a href="#6-è·å–ç‹¬å é”">6. è·å–ç‹¬å é”</a></li>
<li><a href="#7-å¤„ç†ä¸­æ–­çŠ¶æ€">7. å¤„ç†ä¸­æ–­çŠ¶æ€</a></li>
<li><a href="#å¸¦è¶…æ—¶æœºåˆ¶çš„-await">* å¸¦è¶…æ—¶æœºåˆ¶çš„ await</a></li>
<li><a href="#ä¸æŠ›å‡º-interruptedexception-çš„-await">* ä¸æŠ›å‡º InterruptedException çš„ await</a></li>
</ul>
</li>
<li><a href="#abstractqueuedsynchronizer-ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ">AbstractQueuedSynchronizer ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ</a></li>
<li><a href="#å†è¯´-java-çº¿ç¨‹ä¸­æ–­å’Œ-interruptedexception-å¼‚å¸¸">å†è¯´ java çº¿ç¨‹ä¸­æ–­å’Œ InterruptedException å¼‚å¸¸</a><ul>
<li><a href="#çº¿ç¨‹ä¸­æ–­">çº¿ç¨‹ä¸­æ–­</a></li>
<li><a href="#interruptedexception-æ¦‚è¿°">InterruptedException æ¦‚è¿°</a></li>
<li><a href="#å¤„ç†ä¸­æ–­">å¤„ç†ä¸­æ–­</a></li>
</ul>
</li>
<li><a href="#æ€»ç»“">æ€»ç»“</a></li>
</ul>
<!-- tocstop -->
<h2 id="å…¬å¹³é”å’Œéå…¬å¹³é”"><a href="#å…¬å¹³é”å’Œéå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”å’Œéå…¬å¹³é”"></a>å…¬å¹³é”å’Œéå…¬å¹³é”</h2><p>ReentrantLock é»˜è®¤é‡‡ç”¨éå…¬å¹³é”ï¼Œé™¤éä½ åœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥å‚æ•° true ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</div><div class="line">    sync = <span class="keyword">new</span> NonfairSync();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</div><div class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¬å¹³é”çš„ lock æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">        acquire(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// AbstractQueuedSynchronizer.acquire(int arg)</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">            selfInterrupt();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">        <span class="keyword">int</span> c = getState();</div><div class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 1. å’Œéå…¬å¹³é”ç›¸æ¯”ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ªåˆ¤æ–­ï¼šæ˜¯å¦æœ‰çº¿ç¨‹åœ¨ç­‰å¾…</span></div><div class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</div><div class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                setExclusiveOwnerThread(current);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">            <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">            setState(nextc);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éå…¬å¹³é”çš„ lock æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// 2. å’Œå…¬å¹³é”ç›¸æ¯”ï¼Œè¿™é‡Œä¼šç›´æ¥å…ˆè¿›è¡Œä¸€æ¬¡CASï¼ŒæˆåŠŸå°±è¿”å›äº†</span></div><div class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">            setExclusiveOwnerThread(Thread.currentThread());</div><div class="line">        <span class="keyword">else</span></div><div class="line">            acquire(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// AbstractQueuedSynchronizer.acquire(int arg)</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">            selfInterrupt();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Performs non-fair tryLock.  tryAcquire is implemented in</div><div class="line"> * subclasses, but both need nonfair try for trylock method.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">    <span class="keyword">int</span> c = getState();</div><div class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">            setExclusiveOwnerThread(current);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">        <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">        setState(nextc);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼šå…¬å¹³é”å’Œéå…¬å¹³é”åªæœ‰ä¸¤å¤„ä¸åŒï¼š</p>
<ol>
<li>éå…¬å¹³é”åœ¨è°ƒç”¨ lock åï¼Œé¦–å…ˆå°±ä¼šè°ƒç”¨ CAS è¿›è¡Œä¸€æ¬¡æŠ¢é”ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æ°å·§é”æ²¡æœ‰è¢«å ç”¨ï¼Œé‚£ä¹ˆç›´æ¥å°±è·å–åˆ°é”è¿”å›äº†ã€‚</li>
<li>éå…¬å¹³é”åœ¨ CAS å¤±è´¥åï¼Œå’Œå…¬å¹³é”ä¸€æ ·éƒ½ä¼šè¿›å…¥åˆ° tryAcquire æ–¹æ³•ï¼Œåœ¨ tryAcquire æ–¹æ³•ä¸­ï¼Œå¦‚æœå‘ç°é”è¿™ä¸ªæ—¶å€™è¢«é‡Šæ”¾äº†ï¼ˆstate == 0ï¼‰ï¼Œéå…¬å¹³é”ä¼šç›´æ¥ CAS æŠ¢é”ï¼Œä½†æ˜¯å…¬å¹³é”ä¼šåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœæœ‰åˆ™ä¸å»æŠ¢é”ï¼Œä¹–ä¹–æ’åˆ°åé¢ã€‚</li>
</ol>
<p>å…¬å¹³é”å’Œéå…¬å¹³é”å°±è¿™ä¸¤ç‚¹åŒºåˆ«ï¼Œå¦‚æœè¿™ä¸¤æ¬¡ CAS éƒ½ä¸æˆåŠŸï¼Œé‚£ä¹ˆåé¢éå…¬å¹³é”å’Œå…¬å¹³é”æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦è¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ç­‰å¾…å”¤é†’ã€‚</p>
<p>ç›¸å¯¹æ¥è¯´ï¼Œéå…¬å¹³é”ä¼šæœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒçš„ååé‡æ¯”è¾ƒå¤§ã€‚å½“ç„¶ï¼Œéå…¬å¹³é”è®©è·å–é”çš„æ—¶é—´å˜å¾—æ›´åŠ ä¸ç¡®å®šï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹é•¿æœŸå¤„äºé¥¥é¥¿çŠ¶æ€ã€‚</p>
<h2 id="condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>Tips: è¿™é‡Œé‡ç”³ä¸€ä¸‹ï¼Œè¦çœ‹æ‡‚è¿™ä¸ªï¼Œå¿…é¡»è¦å…ˆçœ‹æ‡‚ä¸Šä¸€ç¯‡å…³äº <a href="http://hongjiev.github.io/2017/06/16/AbstractQueuedSynchronizer/" target="_blank" rel="external">AbstractQueuedSynchronizer</a> çš„ä»‹ç»ï¼Œæˆ–è€…ä½ å·²ç»æœ‰ç›¸å…³çš„çŸ¥è¯†äº†ï¼Œå¦åˆ™è¿™èŠ‚è‚¯å®šæ˜¯çœ‹ä¸æ‡‚çš„ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Condition çš„ä½¿ç”¨åœºæ™¯ï¼ŒCondition ç»å¸¸å¯ä»¥ç”¨åœ¨<strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</strong>çš„åœºæ™¯ä¸­ï¼Œè¯·çœ‹ Doug Lea ç»™å‡ºçš„è¿™ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoundedBuffer</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">    <span class="comment">// condition ä¾èµ–äº lock æ¥äº§ç”Ÿ</span></div><div class="line">    <span class="keyword">final</span> Condition notFull = lock.newCondition();</div><div class="line">    <span class="keyword">final</span> Condition notEmpty = lock.newCondition();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">new</span> Object[<span class="number">100</span>];</div><div class="line">    <span class="keyword">int</span> putptr, takeptr, count;</div><div class="line"></div><div class="line">    <span class="comment">// ç”Ÿäº§</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object x)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == items.length)</div><div class="line">                notFull.await();  <span class="comment">// é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…ï¼Œç›´åˆ° not full æ‰èƒ½ç»§ç»­ç”Ÿäº§</span></div><div class="line">            items[putptr] = x;</div><div class="line">            <span class="keyword">if</span> (++putptr == items.length) putptr = <span class="number">0</span>;</div><div class="line">            ++count;</div><div class="line">            notEmpty.signal(); <span class="comment">// ç”Ÿäº§æˆåŠŸï¼Œé˜Ÿåˆ—å·²ç» not empty äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå»</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æ¶ˆè´¹</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        lock.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</div><div class="line">                notEmpty.await(); <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ— not emptyï¼Œæ‰èƒ½ç»§ç»­æ¶ˆè´¹</span></div><div class="line">            Object x = items[takeptr];</div><div class="line">            <span class="keyword">if</span> (++takeptr == items.length) takeptr = <span class="number">0</span>;</div><div class="line">            --count;</div><div class="line">            notFull.signal(); <span class="comment">// è¢«æˆ‘æ¶ˆè´¹æ‰ä¸€ä¸ªï¼Œé˜Ÿåˆ— not full äº†ï¼Œå‘ä¸ªé€šçŸ¥å‡ºå»</span></div><div class="line">            <span class="keyword">return</span> x;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>ï¼ˆ<strong>ArrayBlockingQueue</strong> é‡‡ç”¨è¿™ç§æ–¹å¼å®ç°äº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼Œæ‰€ä»¥è¯·åªæŠŠè¿™ä¸ªä¾‹å­å½“åšå­¦ä¹ ä¾‹å­ï¼Œå®é™…ç”Ÿäº§ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ ArrayBlockingQueueï¼‰</em></p>
<p>æˆ‘ä»¬å¸¸ç”¨ obj.wait()ï¼Œobj.notify() æˆ– obj.notifyAll() æ¥å®ç°ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯ï¼Œå®ƒä»¬æ˜¯åŸºäºå¯¹è±¡çš„ç›‘è§†å™¨é”çš„ã€‚éœ€è¦æ·±å…¥äº†è§£è¿™å‡ ä¸ªæ–¹æ³•çš„è¯»è€…ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ã€Š<a href="http://hongjiev.github.io/2017/07/05/Threads-And-Locks-md/" target="_blank" rel="external">æ·±å…¥åˆ†æ java 8 ç¼–ç¨‹è¯­è¨€è§„èŒƒï¼šThreads and Locks</a>ã€‹ã€‚è€Œè¿™é‡Œè¯´çš„ Condition æ˜¯åŸºäº ReentrantLock å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ä¾èµ–äº AbstractQueuedSynchronizer å®ç°çš„ã€‚</p>
<p>åœ¨å¾€ä¸‹çœ‹ä¹‹å‰ï¼Œè¯»è€…å¿ƒé‡Œè¦æœ‰ä¸€ä¸ªæ•´ä½“çš„æ¦‚å¿µã€‚condition æ˜¯ä¾èµ–äº ReentrantLock  çš„ï¼Œä¸ç®¡æ˜¯è°ƒç”¨ await è¿›å…¥ç­‰å¾…è¿˜æ˜¯ signal å”¤é†’ï¼Œéƒ½å¿…é¡»è·å–åˆ°é”æ‰èƒ½è¿›è¡Œæ“ä½œã€‚</p>
<p>æ¯ä¸ª ReentrantLock  å®ä¾‹å¯ä»¥é€šè¿‡è°ƒç”¨å¤šæ¬¡ newCondition äº§ç”Ÿå¤šä¸ª ConditionObject çš„å®ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸‹æˆ‘ä»¬å…³æ³¨çš„ Condition çš„å®ç°ç±» <code>AbstractQueuedSynchronizer</code> ç±»ä¸­çš„ <code>ConditionObject</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionObject</span> <span class="keyword">implements</span> <span class="title">Condition</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1173984872572414699L</span>;</div><div class="line">        <span class="comment">// æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">  		<span class="comment">// ä¸è¦ç®¡è¿™é‡Œçš„å…³é”®å­— transientï¼Œæ˜¯ä¸å‚ä¸åºåˆ—åŒ–çš„æ„æ€</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</div><div class="line">        <span class="comment">// æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</div><div class="line">        ......</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šä¸€ç¯‡ä»‹ç» AQS çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª<strong>é˜»å¡é˜Ÿåˆ—</strong>ï¼Œç”¨äºä¿å­˜ç­‰å¾…è·å–é”çš„çº¿ç¨‹çš„é˜Ÿåˆ—ã€‚è¿™é‡Œæˆ‘ä»¬å¼•å…¥å¦ä¸€ä¸ªæ¦‚å¿µï¼Œå«<strong>æ¡ä»¶é˜Ÿåˆ—</strong>ï¼ˆcondition queueï¼‰ï¼Œæˆ‘ç”»äº†ä¸€å¼ ç®€å•çš„å›¾ç”¨æ¥è¯´æ˜è¿™ä¸ªã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„é˜»å¡é˜Ÿåˆ—å¦‚æœå«åšåŒæ­¥é˜Ÿåˆ—ï¼ˆsync queueï¼‰å…¶å®æ¯”è¾ƒè´´åˆ‡ï¼Œä¸è¿‡ä¸ºäº†å’Œå‰ç¯‡å‘¼åº”ï¼Œæˆ‘å°±ç»§ç»­ä½¿ç”¨é˜»å¡é˜Ÿåˆ—äº†ã€‚è®°ä½è¿™é‡Œçš„ä¸¤ä¸ªæ¦‚å¿µï¼Œ<strong>é˜»å¡é˜Ÿåˆ—</strong>å’Œ<strong>æ¡ä»¶é˜Ÿåˆ—</strong>ã€‚</p>
</blockquote>
<p><img src="/2017/07/20/AbstractQueuedSynchronizer-2/aqs2-2.png" alt="condition-2"></p>
<blockquote>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬ç®€å•å›é¡¾ä¸‹ Node çš„å±æ€§ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus; <span class="comment">// å¯å–å€¼CANCELLED(1)ã€SIGNAL(-1)ã€CONDITION(-2)ã€PROPAGATE(-3)</span></div><div class="line"><span class="keyword">volatile</span> Node prev;</div><div class="line"><span class="keyword">volatile</span> Node next;</div><div class="line"><span class="keyword">volatile</span> Thread thread;</div><div class="line">Node nextWaiter;</div></pre></td></tr></table></figure></p>
<p>prev å’Œ next ç”¨äºå®ç°é˜»å¡é˜Ÿåˆ—çš„åŒå‘é“¾è¡¨ï¼ŒnextWaiter ç”¨äºå®ç°æ¡ä»¶é˜Ÿåˆ—çš„å•å‘é“¾è¡¨</p>
</blockquote>
<p>åŸºæœ¬ä¸Šï¼ŒæŠŠè¿™å¼ å›¾çœ‹æ‡‚ï¼Œä½ ä¹Ÿå°±çŸ¥é“ condition çš„å¤„ç†æµç¨‹äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘å…ˆç®€å•è§£é‡Šä¸‹è¿™å›¾ï¼Œç„¶åå†å…·ä½“åœ°è§£é‡Šä»£ç å®ç°ã€‚</p>
<ol>
<li>æˆ‘ä»¬çŸ¥é“ä¸€ä¸ª ReentrantLock å®ä¾‹å¯ä»¥é€šè¿‡å¤šæ¬¡è°ƒç”¨ newCondition() æ¥äº§ç”Ÿå¤šä¸ª Condition å®ä¾‹ï¼Œè¿™é‡Œå¯¹åº” condition1 å’Œ condition2ã€‚æ³¨æ„ï¼ŒConditionObject åªæœ‰ä¸¤ä¸ªå±æ€§ firstWaiter å’Œ lastWaiterï¼›</li>
</ol>
<ol>
<li>æ¯ä¸ª condition æœ‰ä¸€ä¸ªå…³è”çš„<strong>æ¡ä»¶é˜Ÿåˆ—</strong>ï¼Œå¦‚çº¿ç¨‹ 1 è°ƒç”¨ condition1.await() æ–¹æ³•å³å¯å°†å½“å‰çº¿ç¨‹ 1 åŒ…è£…æˆ Node ååŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ï¼Œç„¶åé˜»å¡åœ¨è¿™é‡Œï¼Œä¸ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ¡ä»¶é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼›</li>
<li>è°ƒç”¨ condition1.signal() ä¼šå°†condition1 å¯¹åº”çš„<strong>æ¡ä»¶é˜Ÿåˆ—</strong>çš„ firstWaiter ç§»åˆ°<strong>é˜»å¡é˜Ÿåˆ—</strong>çš„é˜Ÿå°¾ï¼Œç­‰å¾…è·å–é”ï¼Œè·å–é”å await æ–¹æ³•è¿”å›ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</li>
</ol>
<p>æˆ‘è¿™é‡Œè¯´çš„ 1ã€2ã€3 æ˜¯æœ€ç®€å•çš„æµç¨‹ï¼Œæ²¡æœ‰è€ƒè™‘ä¸­æ–­ã€signalAllã€è¿˜æœ‰å¸¦æœ‰è¶…æ—¶å‚æ•°çš„ await æ–¹æ³•ç­‰ï¼Œä¸è¿‡æŠŠè¿™é‡Œå¼„æ‡‚æ˜¯è¿™èŠ‚çš„ä¸»è¦ç›®çš„ã€‚</p>
<p>åŒæ—¶ï¼Œä»å›¾ä¸­ä¹Ÿå¯ä»¥å¾ˆç›´è§‚åœ°çœ‹å‡ºï¼Œå“ªäº›æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå“ªäº›æ“ä½œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ </p>
<p>è¿™ä¸ªå›¾çœ‹æ‡‚åï¼Œä¸‹é¢çš„ä»£ç åˆ†æå°±ç®€å•äº†ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æŒ‰ç…§æµç¨‹æ¥èµ°ä»£ç åˆ†æï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ wait æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é¦–å…ˆï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯è¢«ä¸­æ–­çš„ï¼Œä¸å¯è¢«ä¸­æ–­çš„æ˜¯å¦ä¸€ä¸ªæ–¹æ³• awaitUninterruptibly()</span></div><div class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è°ƒç”¨ signal æ–¹æ³•ï¼ˆæŒ‡ signal() å’Œ signalAll()ï¼Œä¸‹åŒï¼‰ï¼Œæˆ–è¢«ä¸­æ–­</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Thread.interrupted())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">    <span class="comment">// æ·»åŠ åˆ° condition çš„æ¡ä»¶é˜Ÿåˆ—ä¸­</span></div><div class="line">    Node node = addConditionWaiter();</div><div class="line">    <span class="comment">// é‡Šæ”¾é”ï¼Œè¿”å›å€¼æ˜¯é‡Šæ”¾é”ä¹‹å‰çš„ state å€¼</span></div><div class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</div><div class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</div><div class="line">    <span class="comment">// è¿™é‡Œé€€å‡ºå¾ªç¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¹‹åå†ä»”ç»†åˆ†æ</span></div><div class="line">    <span class="comment">// 1. isOnSyncQueue(node) è¿”å› trueï¼Œå³å½“å‰ node å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†</span></div><div class="line">    <span class="comment">// 2. checkInterruptWhileWaiting(node) != 0 ä¼šåˆ° breakï¼Œç„¶åé€€å‡ºå¾ªç¯ï¼Œä»£è¡¨çš„æ˜¯çº¿ç¨‹ä¸­æ–­</span></div><div class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</div><div class="line">        LockSupport.park(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è¢«å”¤é†’åï¼Œå°†è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”</span></div><div class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</div><div class="line">        interruptMode = REINTERRUPT;</div><div class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></div><div class="line">        unlinkCancelledWaiters();</div><div class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</div><div class="line">        reportInterruptAfterWait(interruptMode);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®ï¼Œæˆ‘å¤§ä½“ä¸Šä¹ŸæŠŠæ•´ä¸ª await è¿‡ç¨‹è¯´å¾—åä¹‹å…«ä¹äº†ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æ­¥æŠŠä¸Šé¢çš„å‡ ä¸ªç‚¹ç”¨æºç è¯´æ¸…æ¥šã€‚</p>
<h3 id="1-å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—"><a href="#1-å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—" class="headerlink" title="1. å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—"></a>1. å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—</h3><p>addConditionWaiter() æ˜¯å°†å½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ï¼Œçœ‹å›¾æˆ‘ä»¬çŸ¥é“ï¼Œè¿™ç§æ¡ä»¶é˜Ÿåˆ—å†…çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å°†å½“å‰çº¿ç¨‹å¯¹åº”çš„èŠ‚ç‚¹å…¥é˜Ÿï¼Œæ’å…¥é˜Ÿå°¾</span></div><div class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</div><div class="line">    Node t = lastWaiter;</div><div class="line">    <span class="comment">// å¦‚æœæ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆäº†ï¼Œå°†å…¶æ¸…é™¤å‡ºå»</span></div><div class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</div><div class="line">        <span class="comment">// è¿™ä¸ªæ–¹æ³•ä¼šéå†æ•´ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼Œç„¶åä¼šå°†å·²å–æ¶ˆçš„æ‰€æœ‰èŠ‚ç‚¹æ¸…é™¤å‡ºé˜Ÿåˆ—</span></div><div class="line">        unlinkCancelledWaiters();</div><div class="line">        t = lastWaiter;</div><div class="line">    &#125;</div><div class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</div><div class="line">    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸ºç©º</span></div><div class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</div><div class="line">        firstWaiter = node;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        t.nextWaiter = node;</div><div class="line">    lastWaiter = node;</div><div class="line">    <span class="keyword">return</span> node;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨addWaiter æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€ä¸ª unlinkCancelledWaiters() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºæ¸…é™¤é˜Ÿåˆ—ä¸­å·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹ã€‚</p>
<p>å½“ await çš„æ—¶å€™å¦‚æœå‘ç”Ÿäº†å–æ¶ˆæ“ä½œï¼ˆè¿™ç‚¹ä¹‹åä¼šè¯´ï¼‰ï¼Œæˆ–è€…æ˜¯åœ¨èŠ‚ç‚¹å…¥é˜Ÿçš„æ—¶å€™ï¼Œå‘ç°æœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯è¢«å–æ¶ˆçš„ï¼Œä¼šè°ƒç”¨ä¸€æ¬¡è¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œéå†é“¾è¡¨å°†å·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹æ¸…é™¤å‡ºå»</span></div><div class="line"><span class="comment">// çº¯å±é“¾è¡¨æ“ä½œï¼Œå¾ˆå¥½ç†è§£ï¼Œçœ‹ä¸æ‡‚å¤šçœ‹å‡ éå°±å¯ä»¥äº†</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlinkCancelledWaiters</span><span class="params">()</span> </span>&#123;</div><div class="line">    Node t = firstWaiter;</div><div class="line">    Node trail = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">while</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">        Node next = t.nextWaiter;</div><div class="line">        <span class="comment">// å¦‚æœèŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ Node.CONDITION çš„è¯ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯è¢«å–æ¶ˆçš„</span></div><div class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123;</div><div class="line">            t.nextWaiter = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (trail == <span class="keyword">null</span>)</div><div class="line">                firstWaiter = next;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                trail.nextWaiter = next;</div><div class="line">            <span class="keyword">if</span> (next == <span class="keyword">null</span>)</div><div class="line">                lastWaiter = trail;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            trail = t;</div><div class="line">        t = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-å®Œå…¨é‡Šæ”¾ç‹¬å é”"><a href="#2-å®Œå…¨é‡Šæ”¾ç‹¬å é”" class="headerlink" title="2. å®Œå…¨é‡Šæ”¾ç‹¬å é”"></a>2. å®Œå…¨é‡Šæ”¾ç‹¬å é”</h3><p>å›åˆ° wait æ–¹æ³•ï¼ŒèŠ‚ç‚¹å…¥é˜Ÿäº†ä»¥åï¼Œä¼šè°ƒç”¨ <code>int savedState = fullyRelease(node);</code> æ–¹æ³•é‡Šæ”¾é”ï¼Œæ³¨æ„ï¼Œè¿™é‡Œæ˜¯å®Œå…¨é‡Šæ”¾ç‹¬å é”ï¼Œå› ä¸º ReentrantLock æ˜¯å¯ä»¥é‡å…¥çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// é¦–å…ˆï¼Œæˆ‘ä»¬è¦å…ˆè§‚å¯Ÿåˆ°è¿”å›å€¼ savedState ä»£è¡¨ release ä¹‹å‰çš„ state å€¼</span></div><div class="line"><span class="comment">// å¯¹äºæœ€ç®€å•çš„æ“ä½œï¼šå…ˆ lock.lock()ï¼Œç„¶å condition1.await()ã€‚</span></div><div class="line"><span class="comment">// 		é‚£ä¹ˆ state ç»è¿‡è¿™ä¸ªæ–¹æ³•ç”± 1 å˜ä¸º 0ï¼Œé”é‡Šæ”¾ï¼Œæ­¤æ–¹æ³•è¿”å› 1</span></div><div class="line"><span class="comment">// 		ç›¸åº”çš„ï¼Œå¦‚æœ lock é‡å…¥äº† n æ¬¡ï¼ŒsavedState == n</span></div><div class="line"><span class="comment">// å¦‚æœè¿™ä¸ªæ–¹æ³•å¤±è´¥ï¼Œä¼šå°†èŠ‚ç‚¹è®¾ç½®ä¸º"å–æ¶ˆ"çŠ¶æ€ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ IllegalMonitorStateException</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> savedState = getState();</div><div class="line">        <span class="comment">// è¿™é‡Œä½¿ç”¨äº†å½“å‰çš„ state ä½œä¸º release çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨é‡Šæ”¾æ‰é”ï¼Œå°† state ç½®ä¸º 0</span></div><div class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</div><div class="line">            failed = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">return</span> savedState;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (failed)</div><div class="line">            node.waitStatus = Node.CANCELLED;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—"><a href="#3-ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—" class="headerlink" title="3. ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—"></a>3. ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</h3><p>é‡Šæ”¾æ‰é”ä»¥åï¼Œæ¥ä¸‹æ¥æ˜¯è¿™æ®µï¼Œè¿™è¾¹ä¼šè‡ªæ—‹ï¼Œå¦‚æœå‘ç°è‡ªå·±è¿˜æ²¡åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæŒ‚èµ·ï¼Œç­‰å¾…è¢«è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> interruptMode = <span class="number">0</span>;</div><div class="line"><span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</div><div class="line">    <span class="comment">// çº¿ç¨‹æŒ‚èµ·</span></div><div class="line">    LockSupport.park(<span class="keyword">this</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>isOnSyncQueue(Node node) ç”¨äºåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åœ¨èŠ‚ç‚¹å…¥æ¡ä»¶é˜Ÿåˆ—çš„æ—¶å€™ï¼Œåˆå§‹åŒ–æ—¶è®¾ç½®äº† waitStatus = Node.CONDITION</span></div><div class="line"><span class="comment">// å‰é¢æˆ‘æåˆ°ï¼Œsignal çš„æ—¶å€™éœ€è¦å°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œ</span></div><div class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ¤æ–­ node æ˜¯å¦å·²ç»ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—äº†</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç§»åŠ¨è¿‡å»çš„æ—¶å€™ï¼Œnode çš„ waitStatus ä¼šç½®ä¸º 0ï¼Œè¿™ä¸ªä¹‹ååœ¨è¯´ signal æ–¹æ³•çš„æ—¶å€™ä¼šè¯´åˆ°</span></div><div class="line">    <span class="comment">// å¦‚æœ waitStatus è¿˜æ˜¯ Node.CONDITIONï¼Œä¹Ÿå°±æ˜¯ 2ï¼Œé‚£è‚¯å®šå°±æ˜¯è¿˜åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­</span></div><div class="line">    <span class="comment">// å¦‚æœ node çš„å‰é©± prev æŒ‡å‘è¿˜æ˜¯ nullï¼Œè¯´æ˜è‚¯å®šæ²¡æœ‰åœ¨ é˜»å¡é˜Ÿåˆ—</span></div><div class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="comment">// å¦‚æœ node å·²ç»æœ‰åç»§èŠ‚ç‚¹ next çš„æ—¶å€™ï¼Œé‚£è‚¯å®šæ˜¯åœ¨é˜»å¡é˜Ÿåˆ—äº†</span></div><div class="line">    <span class="keyword">if</span> (node.next != <span class="keyword">null</span>) </div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—çš„é˜Ÿå°¾å¼€å§‹ä»åå¾€å‰éå†æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ç›¸ç­‰çš„ï¼Œè¯´æ˜åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œå¦åˆ™å°±æ˜¯ä¸åœ¨é˜»å¡é˜Ÿåˆ—</span></div><div class="line">  </div><div class="line">    <span class="comment">// å¯ä»¥é€šè¿‡åˆ¤æ–­ node.prev() != null æ¥æ¨æ–­å‡º node åœ¨é˜»å¡é˜Ÿåˆ—å—ï¼Ÿç­”æ¡ˆæ˜¯ï¼šä¸èƒ½ã€‚</span></div><div class="line">    <span class="comment">// è¿™ä¸ªå¯ä»¥çœ‹ä¸Šç¯‡ AQS çš„å…¥é˜Ÿæ–¹æ³•ï¼Œé¦–å…ˆè®¾ç½®çš„æ˜¯ node.prev æŒ‡å‘ tailï¼Œ</span></div><div class="line">    <span class="comment">// ç„¶åæ˜¯ CAS æ“ä½œå°†è‡ªå·±è®¾ç½®ä¸ºæ–°çš„ tailï¼Œå¯æ˜¯è¿™æ¬¡çš„ CAS æ˜¯å¯èƒ½å¤±è´¥çš„ã€‚</span></div><div class="line">  </div><div class="line">    <span class="comment">// è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå¾€å¾€æˆ‘ä»¬éœ€è¦çš„å°±åœ¨é˜Ÿå°¾çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¸éœ€è¦å®Œå…¨éå†æ•´ä¸ªé˜Ÿåˆ—çš„</span></div><div class="line">    <span class="keyword">return</span> findNodeFromTail(node);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ä»åŒæ­¥é˜Ÿåˆ—çš„é˜Ÿå°¾å¾€å‰éå†ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œè¿”å› true</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">findNodeFromTail</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    Node t = tail;</div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">if</span> (t == node)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        t = t.prev;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å›åˆ°å‰é¢çš„å¾ªç¯ï¼ŒisOnSyncQueue(node) è¿”å› false çš„è¯ï¼Œé‚£ä¹ˆè¿›åˆ° <code>LockSupport.park(this);</code> è¿™é‡Œçº¿ç¨‹æŒ‚èµ·ã€‚</p>
<h3 id="4-signal-å”¤é†’çº¿ç¨‹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—"><a href="#4-signal-å”¤é†’çº¿ç¨‹ï¼Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—" class="headerlink" title="4. signal å”¤é†’çº¿ç¨‹ï¼Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—"></a>4. signal å”¤é†’çº¿ç¨‹ï¼Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</h3><p>ä¸ºäº†å¤§å®¶ç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœ‹å”¤é†’æ“ä½œï¼Œå› ä¸ºåˆšåˆšåˆ° LockSupport.park(this); æŠŠçº¿ç¨‹æŒ‚èµ·äº†ï¼Œç­‰å¾…å”¤é†’ã€‚</p>
<p>å”¤é†’æ“ä½œé€šå¸¸ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œï¼Œå°±åƒç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œå¦‚æœçº¿ç¨‹å› ä¸ºç­‰å¾…æ¶ˆè´¹è€ŒæŒ‚èµ·ï¼Œé‚£ä¹ˆå½“ç”Ÿäº§è€…ç”Ÿäº§äº†ä¸€ä¸ªä¸œè¥¿åï¼Œä¼šè°ƒç”¨ signal å”¤é†’æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹æ¥æ¶ˆè´¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// å”¤é†’ç­‰å¾…äº†æœ€ä¹…çš„çº¿ç¨‹</span></div><div class="line"><span class="comment">// å…¶å®å°±æ˜¯ï¼Œå°†è¿™ä¸ªçº¿ç¨‹å¯¹åº”çš„ node ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹å¿…é¡»æŒæœ‰å½“å‰çš„ç‹¬å é”</span></div><div class="line">    <span class="keyword">if</span> (!isHeldExclusively())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</div><div class="line">    Node first = firstWaiter;</div><div class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</div><div class="line">        doSignal(first);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ä»æ¡ä»¶é˜Ÿåˆ—é˜Ÿå¤´å¾€åéå†ï¼Œæ‰¾å‡ºç¬¬ä¸€ä¸ªéœ€è¦è½¬ç§»çš„ node</span></div><div class="line"><span class="comment">// å› ä¸ºå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œæœ‰äº›çº¿ç¨‹ä¼šå–æ¶ˆæ’é˜Ÿï¼Œä½†æ˜¯è¿˜åœ¨é˜Ÿåˆ—ä¸­</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">      	<span class="comment">// å°† firstWaiter æŒ‡å‘ first èŠ‚ç‚¹åé¢çš„ç¬¬ä¸€ä¸ª</span></div><div class="line">        <span class="comment">// å¦‚æœå°†é˜Ÿå¤´ç§»é™¤åï¼Œåé¢æ²¡æœ‰èŠ‚ç‚¹åœ¨ç­‰å¾…äº†ï¼Œé‚£ä¹ˆéœ€è¦å°† lastWaiter ç½®ä¸º null</span></div><div class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</div><div class="line">            lastWaiter = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// å› ä¸º first é©¬ä¸Šè¦è¢«ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†ï¼Œå’Œæ¡ä»¶é˜Ÿåˆ—çš„é“¾æ¥å…³ç³»åœ¨è¿™é‡Œæ–­æ‰</span></div><div class="line">        first.nextWaiter = <span class="keyword">null</span>;</div><div class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</div><div class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</div><div class="line">      <span class="comment">// è¿™é‡Œ while å¾ªç¯ï¼Œå¦‚æœ first è½¬ç§»ä¸æˆåŠŸï¼Œé‚£ä¹ˆé€‰æ‹© first åé¢çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè½¬ç§»ï¼Œä¾æ­¤ç±»æ¨</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// å°†èŠ‚ç‚¹ä»æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">// true ä»£è¡¨æˆåŠŸè½¬ç§»</span></div><div class="line"><span class="comment">// false ä»£è¡¨åœ¨ signal ä¹‹å‰ï¼ŒèŠ‚ç‚¹å·²ç»å–æ¶ˆäº†</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">// CAS å¦‚æœå¤±è´¥ï¼Œè¯´æ˜æ­¤ node çš„ waitStatus å·²ä¸æ˜¯ Node.CONDITIONï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œ</span></div><div class="line">    <span class="comment">// æ—¢ç„¶å·²ç»å–æ¶ˆï¼Œä¹Ÿå°±ä¸éœ€è¦è½¬ç§»äº†ï¼Œæ–¹æ³•è¿”å›ï¼Œè½¬ç§»åé¢ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">    <span class="comment">// å¦åˆ™ï¼Œå°† waitStatus ç½®ä¸º 0</span></div><div class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  </div><div class="line">    <span class="comment">// enq(node): è‡ªæ—‹è¿›å…¥é˜»å¡é˜Ÿåˆ—çš„é˜Ÿå°¾</span></div><div class="line">    <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„è¿”å›å€¼ p æ˜¯ node åœ¨é˜»å¡é˜Ÿåˆ—çš„å‰é©±èŠ‚ç‚¹</span></div><div class="line">    Node p = enq(node);</div><div class="line">    <span class="keyword">int</span> ws = p.waitStatus;</div><div class="line">    <span class="comment">// ws &gt; 0 è¯´æ˜ node åœ¨é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ç­‰å¾…é”ï¼Œç›´æ¥å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚å”¤é†’ä¹‹åä¼šæ€ä¹ˆæ ·ï¼Œåé¢å†è§£é‡Š</span></div><div class="line">    <span class="comment">// å¦‚æœ ws &lt;= 0, é‚£ä¹ˆ compareAndSetWaitStatus å°†ä¼šè¢«è°ƒç”¨ï¼Œä¸Šç¯‡ä»‹ç»çš„æ—¶å€™è¯´è¿‡ï¼ŒèŠ‚ç‚¹å…¥é˜Ÿåï¼Œéœ€è¦æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ä¸º Node.SIGNAL(-1)</span></div><div class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</div><div class="line">        <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆæˆ–è€… CAS å¤±è´¥ï¼Œä¼šè¿›åˆ°è¿™é‡Œå”¤é†’çº¿ç¨‹ï¼Œä¹‹åçš„æ“ä½œçœ‹ä¸‹ä¸€èŠ‚</span></div><div class="line">        LockSupport.unpark(node.thread);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ<code>ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL)</code> è¿™å¥ä¸­ï¼Œws &lt;= 0ï¼Œè€Œä¸” compareAndSetWaitStatus(p, ws, Node.SIGNAL) ä¼šè¿”å› trueï¼Œæ‰€ä»¥ä¸€èˆ¬ä¹Ÿä¸ä¼šè¿›å» if è¯­å¥å—ä¸­å”¤é†’ node å¯¹åº”çš„çº¿ç¨‹ã€‚ç„¶åè¿™ä¸ªæ–¹æ³•è¿”å› trueï¼Œä¹Ÿå°±æ„å‘³ç€ signal æ–¹æ³•ç»“æŸäº†ï¼ŒèŠ‚ç‚¹è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ã€‚</p>
<p>å‡è®¾å‘ç”Ÿäº†é˜»å¡é˜Ÿåˆ—ä¸­çš„å‰é©±èŠ‚ç‚¹å–æ¶ˆç­‰å¾…ï¼Œæˆ–è€… CAS å¤±è´¥ï¼Œåªè¦å”¤é†’çº¿ç¨‹ï¼Œè®©å…¶è¿›åˆ°ä¸‹ä¸€æ­¥å³å¯ã€‚</p>
<h3 id="5-å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€"><a href="#5-å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€" class="headerlink" title="5. å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€"></a>5. å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€</h3><p>ä¸Šä¸€æ­¥ signal ä¹‹åï¼Œæˆ‘ä»¬çš„çº¿ç¨‹ç”±æ¡ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°äº†é˜»å¡é˜Ÿåˆ—ï¼Œä¹‹åå°±å‡†å¤‡è·å–é”äº†ã€‚åªè¦é‡æ–°è·å–åˆ°é”äº†ä»¥åï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>ç­‰çº¿ç¨‹ä»æŒ‚èµ·ä¸­æ¢å¤è¿‡æ¥ï¼Œç»§ç»­å¾€ä¸‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> interruptMode = <span class="number">0</span>;</div><div class="line"><span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</div><div class="line">    <span class="comment">// çº¿ç¨‹æŒ‚èµ·</span></div><div class="line">    LockSupport.park(<span class="keyword">this</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆè§£é‡Šä¸‹ interruptModeã€‚interruptMode å¯ä»¥å–å€¼ä¸º REINTERRUPTï¼ˆ1ï¼‰ï¼ŒTHROW_IEï¼ˆ-1ï¼‰ï¼Œ0</p>
<ul>
<li>REINTERRUPTï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°è®¾ç½®ä¸­æ–­çŠ¶æ€</li>
<li>THROW_IEï¼š ä»£è¡¨ await è¿”å›çš„æ—¶å€™ï¼Œéœ€è¦æŠ›å‡º InterruptedException å¼‚å¸¸</li>
<li>0 ï¼šè¯´æ˜åœ¨ await æœŸé—´ï¼Œæ²¡æœ‰å‘ç”Ÿä¸­æ–­</li>
</ul>
<p>æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¼šè®© LockSupport.park(this); è¿™å¥è¿”å›ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼š</p>
<ol>
<li>å¸¸è§„è·¯åŠ²ã€‚signal -&gt; è½¬ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ— -&gt; è·å–äº†é”ï¼ˆunparkï¼‰</li>
<li>çº¿ç¨‹ä¸­æ–­ã€‚åœ¨ park çš„æ—¶å€™ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªçº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­</li>
<li>signal çš„æ—¶å€™æˆ‘ä»¬è¯´è¿‡ï¼Œè½¬ç§»ä»¥åçš„å‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œæˆ–è€…å¯¹å‰é©±èŠ‚ç‚¹çš„CASæ“ä½œå¤±è´¥äº†</li>
<li>å‡å”¤é†’ã€‚è¿™ä¸ªä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå’Œ Object.wait() ç±»ä¼¼ï¼Œéƒ½æœ‰è¿™ä¸ªé—®é¢˜</li>
</ol>
<p>çº¿ç¨‹å”¤é†’åç¬¬ä¸€æ­¥æ˜¯è°ƒç”¨ checkInterruptWhileWaiting(node) è¿™ä¸ªæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨çº¿ç¨‹æŒ‚èµ·æœŸé—´å‘ç”Ÿäº†ä¸­æ–­ï¼Œå¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œæ˜¯ signal è°ƒç”¨ä¹‹å‰ä¸­æ–­çš„ï¼Œè¿˜æ˜¯ signal ä¹‹åå‘ç”Ÿçš„ä¸­æ–­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1. å¦‚æœåœ¨ signal ä¹‹å‰å·²ç»ä¸­æ–­ï¼Œè¿”å› THROW_IE</span></div><div class="line"><span class="comment">// 2. å¦‚æœæ˜¯ signal ä¹‹åä¸­æ–­ï¼Œè¿”å› REINTERRUPT</span></div><div class="line"><span class="comment">// 3. æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œè¿”å› 0</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Thread.interrupted() ?</div><div class="line">        (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :</div><div class="line">        <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Thread.interrupted()ï¼šå¦‚æœå½“å‰çº¿ç¨‹å·²ç»å¤„äºä¸­æ–­çŠ¶æ€ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•è¿”å› trueï¼ŒåŒæ—¶å°†ä¸­æ–­çŠ¶æ€é‡ç½®ä¸º falseï¼Œæ‰€ä»¥ï¼Œæ‰æœ‰åç»­çš„ <code>é‡æ–°ä¸­æ–­ï¼ˆREINTERRUPTï¼‰</code> çš„ä½¿ç”¨ã€‚</p>
</blockquote>
<p>çœ‹çœ‹æ€ä¹ˆåˆ¤æ–­æ˜¯ signal ä¹‹å‰è¿˜æ˜¯ä¹‹åå‘ç”Ÿçš„ä¸­æ–­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// åªæœ‰çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€ï¼Œæ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span></div><div class="line"><span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œå°†è¿™ä¸ªå·²ç»å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></div><div class="line"><span class="comment">// è¿”å› trueï¼šå¦‚æœæ­¤çº¿ç¨‹åœ¨ signal ä¹‹å‰è¢«å–æ¶ˆï¼Œ</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferAfterCancelledWait</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="comment">// ç”¨ CAS å°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸º 0 </span></div><div class="line">    <span class="comment">// å¦‚æœè¿™æ­¥ CAS æˆåŠŸï¼Œè¯´æ˜æ˜¯ signal æ–¹æ³•ä¹‹å‰å‘ç”Ÿçš„ä¸­æ–­ï¼Œå› ä¸ºå¦‚æœ signal å…ˆå‘ç”Ÿçš„è¯ï¼Œsignal ä¸­ä¼šå°† waitStatus è®¾ç½®ä¸º 0</span></div><div class="line">    <span class="keyword">if</span> (compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>)) &#123;</div><div class="line">        <span class="comment">// å°†èŠ‚ç‚¹æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span></div><div class="line">        <span class="comment">// è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå³ä½¿ä¸­æ–­äº†ï¼Œä¾ç„¶ä¼šè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></div><div class="line">        enq(node);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// åˆ°è¿™é‡Œæ˜¯å› ä¸º CAS å¤±è´¥ï¼Œè‚¯å®šæ˜¯å› ä¸º signal æ–¹æ³•å·²ç»å°† waitStatus è®¾ç½®ä¸ºäº† 0</span></div><div class="line">    <span class="comment">// signal æ–¹æ³•ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¯èƒ½è¿˜æ²¡å®Œæˆï¼Œè¿™è¾¹è‡ªæ—‹ç­‰å¾…å…¶å®Œæˆ</span></div><div class="line">    <span class="comment">// å½“ç„¶ï¼Œè¿™ç§äº‹æƒ…è¿˜æ˜¯æ¯”è¾ƒå°‘çš„å§ï¼šsignal è°ƒç”¨ä¹‹åï¼Œæ²¡å®Œæˆè½¬ç§»ä¹‹å‰ï¼Œå‘ç”Ÿäº†ä¸­æ–­</span></div><div class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node))</div><div class="line">        Thread.yield();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œå†è¯´ä¸€éï¼Œå³ä½¿å‘ç”Ÿäº†ä¸­æ–­ï¼ŒèŠ‚ç‚¹ä¾ç„¶ä¼šè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‚</p>
</blockquote>
<p>åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥éƒ½çŸ¥é“è¿™ä¸ª while å¾ªç¯æ€ä¹ˆé€€å‡ºäº†å§ã€‚è¦ä¹ˆä¸­æ–­ï¼Œè¦ä¹ˆè½¬ç§»æˆåŠŸã€‚</p>
<h3 id="6-è·å–ç‹¬å é”"><a href="#6-è·å–ç‹¬å é”" class="headerlink" title="6. è·å–ç‹¬å é”"></a>6. è·å–ç‹¬å é”</h3><p>while å¾ªç¯å‡ºæ¥ä»¥åï¼Œä¸‹é¢æ˜¯è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</div><div class="line">    interruptMode = REINTERRUPT;</div></pre></td></tr></table></figure>
<p>ç”±äº while å‡ºæ¥åï¼Œæˆ‘ä»¬ç¡®å®šèŠ‚ç‚¹å·²ç»è¿›å…¥äº†é˜»å¡é˜Ÿåˆ—ï¼Œå‡†å¤‡è·å–é”ã€‚</p>
<p>è¿™é‡Œçš„ acquireQueued(node, savedState) çš„ç¬¬ä¸€ä¸ªå‚æ•° node ä¹‹å‰å·²ç»ç»è¿‡ enq(node) è¿›å…¥äº†é˜Ÿåˆ—ï¼Œå‚æ•° savedState æ˜¯ä¹‹å‰é‡Šæ”¾é”å‰çš„ stateï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œä»£è¡¨å½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œä¸” state == savedStateäº†ã€‚</p>
<p>æ³¨æ„ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å‘ç”Ÿä¸­æ–­ï¼Œéƒ½ä¼šè¿›å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè€Œ acquireQueued(node, savedState) çš„è¿”å›å€¼å°±æ˜¯ä»£è¡¨çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚å¦‚æœè¿”å› trueï¼Œè¯´æ˜è¢«ä¸­æ–­äº†ï¼Œè€Œä¸” interruptMode != THROW_IEï¼Œè¯´æ˜åœ¨ signal ä¹‹å‰å°±å‘ç”Ÿä¸­æ–­äº†ï¼Œè¿™é‡Œå°† interruptMode è®¾ç½®ä¸º REINTERRUPTï¼Œç”¨äºå¾…ä¼šé‡æ–°ä¸­æ–­ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>) <span class="comment">// clean up if cancelled</span></div><div class="line">    unlinkCancelledWaiters();</div><div class="line"><span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</div><div class="line">    reportInterruptAfterWait(interruptMode);</div></pre></td></tr></table></figure>
<p>æœ¬ç€ä¸€ä¸ä¸è‹Ÿçš„ç²¾ç¥ï¼Œè¿™è¾¹è¯´è¯´ <code>node.nextWaiter != null</code> æ€ä¹ˆæ»¡è¶³ã€‚æˆ‘å‰é¢ä¹Ÿè¯´äº† signal çš„æ—¶å€™ä¼šå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæœ‰ä¸€æ­¥æ˜¯ node.nextWaiter = nullï¼Œå°†æ–­å¼€èŠ‚ç‚¹å’Œæ¡ä»¶é˜Ÿåˆ—çš„è”ç³»ã€‚</p>
<p>å¯æ˜¯ï¼Œ<code>åœ¨åˆ¤æ–­å‘ç”Ÿä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ˜¯ signal ä¹‹å‰è¿˜æ˜¯ä¹‹åå‘ç”Ÿçš„ï¼Ÿ</code> è¿™éƒ¨åˆ†çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿä»‹ç»äº†ï¼Œå¦‚æœ signal ä¹‹å‰å°±ä¸­æ–­äº†ï¼Œä¹Ÿéœ€è¦å°†èŠ‚ç‚¹è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œè¿™éƒ¨åˆ†è½¬ç§»çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰è®¾ç½® node.nextWaiter = null çš„ã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œå¦‚æœæœ‰èŠ‚ç‚¹å–æ¶ˆï¼Œä¹Ÿä¼šè°ƒç”¨ unlinkCancelledWaiters è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è¿™é‡Œäº†ã€‚</p>
<h3 id="7-å¤„ç†ä¸­æ–­çŠ¶æ€"><a href="#7-å¤„ç†ä¸­æ–­çŠ¶æ€" class="headerlink" title="7. å¤„ç†ä¸­æ–­çŠ¶æ€"></a>7. å¤„ç†ä¸­æ–­çŠ¶æ€</h3><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å¥½å¥½è¯´ä¸‹è¿™ä¸ª interruptMode å¹²å˜›ç”¨äº†ã€‚</p>
<ul>
<li>0ï¼šä»€ä¹ˆéƒ½ä¸åšã€‚</li>
<li>THROW_IEï¼šawait æ–¹æ³•æŠ›å‡º InterruptedException å¼‚å¸¸</li>
<li>REINTERRUPTï¼šé‡æ–°ä¸­æ–­å½“å‰çº¿ç¨‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportInterruptAfterWait</span><span class="params">(<span class="keyword">int</span> interruptMode)</span></span></div><div class="line">    <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">    <span class="keyword">if</span> (interruptMode == THROW_IE)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</div><div class="line">        selfInterrupt();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤„ç†ï¼Ÿè¿™éƒ¨åˆ†çš„çŸ¥è¯†åœ¨æœ¬æ–‡çš„æœ€åä¸€èŠ‚</p>
</blockquote>
<h3 id="å¸¦è¶…æ—¶æœºåˆ¶çš„-await"><a href="#å¸¦è¶…æ—¶æœºåˆ¶çš„-await" class="headerlink" title="* å¸¦è¶…æ—¶æœºåˆ¶çš„ await"></a>* å¸¦è¶…æ—¶æœºåˆ¶çš„ await</h3><p>ç»è¿‡å‰é¢çš„ 7 æ­¥ï¼Œæ•´ä¸ª ConditionObject ç±»åŸºæœ¬ä¸Šéƒ½åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥ç®€å•åˆ†æä¸‹å¸¦è¶…æ—¶æœºåˆ¶çš„ await æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">awaitNanos</span><span class="params">(<span class="keyword">long</span> nanosTimeout)</span> </span></div><div class="line">  				<span class="keyword">throws</span> InterruptedException</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">awaitUntil</span><span class="params">(Date deadline)</span></div><div class="line">                <span class="keyword">throws</span> InterruptedException</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></div><div class="line">                <span class="keyword">throws</span> InterruptedException</div></pre></td></tr></table></figure>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½å·®ä¸å¤šï¼Œæˆ‘ä»¬å°±æŒ‘ä¸€ä¸ªå‡ºæ¥çœ‹çœ‹å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">    <span class="comment">// ç­‰å¾…è¿™ä¹ˆå¤šçº³ç§’</span></div><div class="line">    <span class="keyword">long</span> nanosTimeout = unit.toNanos(time);</div><div class="line">    <span class="keyword">if</span> (Thread.interrupted())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">    Node node = addConditionWaiter();</div><div class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</div><div class="line">    <span class="comment">// å½“å‰æ—¶é—´ + ç­‰å¾…æ—¶é•¿ = è¿‡æœŸæ—¶é—´</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = System.nanoTime() + nanosTimeout;</div><div class="line">    <span class="comment">// ç”¨äºè¿”å› await æ˜¯å¦è¶…æ—¶</span></div><div class="line">    <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</div><div class="line">        <span class="comment">// æ—¶é—´åˆ°å•¦</span></div><div class="line">        <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>) &#123;</div><div class="line">            <span class="comment">// è¿™é‡Œå› ä¸ºè¦ break å–æ¶ˆç­‰å¾…äº†ã€‚å–æ¶ˆç­‰å¾…çš„è¯ä¸€å®šè¦è°ƒç”¨ transferAfterCancelledWait(node) è¿™ä¸ªæ–¹æ³•</span></div><div class="line">            <span class="comment">// å¦‚æœè¿™ä¸ªæ–¹æ³•è¿”å› trueï¼Œåœ¨è¿™ä¸ªæ–¹æ³•å†…ï¼Œå°†èŠ‚ç‚¹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—æˆåŠŸ</span></div><div class="line">            <span class="comment">// è¿”å› false çš„è¯ï¼Œè¯´æ˜ signal å·²ç»å‘ç”Ÿï¼Œsignal æ–¹æ³•å°†èŠ‚ç‚¹è½¬ç§»äº†ã€‚ä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰è¶…æ—¶å˜›</span></div><div class="line">            timedout = transferAfterCancelledWait(node);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// spinForTimeoutThreshold çš„å€¼æ˜¯ 1000 çº³ç§’ï¼Œä¹Ÿå°±æ˜¯ 1 æ¯«ç§’</span></div><div class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸åˆ° 1 æ¯«ç§’äº†ï¼Œé‚£å°±ä¸è¦é€‰æ‹© parkNanos äº†ï¼Œè‡ªæ—‹çš„æ€§èƒ½åè€Œæ›´å¥½</span></div><div class="line">        <span class="keyword">if</span> (nanosTimeout &gt;= spinForTimeoutThreshold)</div><div class="line">            LockSupport.parkNanos(<span class="keyword">this</span>, nanosTimeout);</div><div class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">// å¾—åˆ°å‰©ä½™æ—¶é—´</span></div><div class="line">        nanosTimeout = deadline - System.nanoTime();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</div><div class="line">        interruptMode = REINTERRUPT;</div><div class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>)</div><div class="line">        unlinkCancelledWaiters();</div><div class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</div><div class="line">        reportInterruptAfterWait(interruptMode);</div><div class="line">    <span class="keyword">return</span> !timedout;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¶…æ—¶çš„æ€è·¯è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸å¸¦è¶…æ—¶å‚æ•°çš„ await æ˜¯ parkï¼Œç„¶åç­‰å¾…åˆ«äººå”¤é†’ã€‚è€Œç°åœ¨å°±æ˜¯è°ƒç”¨ parkNanos æ–¹æ³•æ¥ä¼‘çœ æŒ‡å®šçš„æ—¶é—´ï¼Œé†’æ¥ååˆ¤æ–­æ˜¯å¦ signal è°ƒç”¨äº†ï¼Œè°ƒç”¨äº†å°±æ˜¯æ²¡æœ‰è¶…æ—¶ï¼Œå¦åˆ™å°±æ˜¯è¶…æ—¶äº†ã€‚è¶…æ—¶çš„è¯ï¼Œè‡ªå·±æ¥è¿›è¡Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œç„¶åæŠ¢é”ã€‚</p>
<h3 id="ä¸æŠ›å‡º-interruptedexception-çš„-await"><a href="#ä¸æŠ›å‡º-InterruptedException-çš„-await" class="headerlink" title="* ä¸æŠ›å‡º InterruptedException çš„ await"></a>* ä¸æŠ›å‡º InterruptedException çš„ await</h3><p>å…³äº Condition æœ€åä¸€å°èŠ‚äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">awaitUninterruptibly</span><span class="params">()</span> </span>&#123;</div><div class="line">    Node node = addConditionWaiter();</div><div class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</div><div class="line">    <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</div><div class="line">        LockSupport.park(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (Thread.interrupted())</div><div class="line">            interrupted = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</div><div class="line">        selfInterrupt();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼Œæˆ‘å°±ä¸åºŸè¯äº†ã€‚</p>
<h2 id="abstractqueuedsynchronizer-ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ"><a href="#AbstractQueuedSynchronizer-ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ" class="headerlink" title="AbstractQueuedSynchronizer ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ"></a>AbstractQueuedSynchronizer ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ</h2><p>è¿™ç¯‡æ–‡ç« è¯´çš„æ˜¯ AbstractQueuedSynchronizerï¼Œåªä¸è¿‡å¥½åƒ Condition è¯´å¤ªå¤šäº†ï¼Œèµ¶ç´§æŠŠæ€è·¯æ‹‰å›æ¥ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘æƒ³è¯´è¯´æ€ä¹ˆå–æ¶ˆå¯¹é”çš„ç«äº‰ï¼Ÿ</p>
<p>ä¸Šç¯‡æ–‡ç« æåˆ°è¿‡ï¼Œæœ€é‡è¦çš„æ–¹æ³•æ˜¯è¿™ä¸ªï¼Œæˆ‘ä»¬è¦åœ¨è¿™é‡Œé¢æ‰¾ç­”æ¡ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">final</span> Node p = node.predecessor();</div><div class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</div><div class="line">                setHead(node);</div><div class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></div><div class="line">                failed = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">return</span> interrupted;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div class="line">                parkAndCheckInterrupt())</div><div class="line">                interrupted = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (failed)</div><div class="line">            cancelAcquire(node);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œåˆ°è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹ä¸€å®šæ˜¯å…¥é˜ŸæˆåŠŸçš„ã€‚</p>
<p>æˆ‘æŠŠ parkAndCheckInterrupt() ä»£ç è´´è¿‡æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</div><div class="line">    LockSupport.park(<span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> Thread.interrupted();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸¤æ®µä»£ç è”ç³»èµ·æ¥çœ‹ï¼Œæ˜¯ä¸æ˜¯å°±æ¸…æ¥šäº†ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¦å–æ¶ˆä¸€ä¸ªçº¿ç¨‹çš„æ’é˜Ÿï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­å¯¹å…¶è¿›è¡Œä¸­æ–­ã€‚æ¯”å¦‚æŸçº¿ç¨‹è°ƒç”¨ lock() è€ä¹…ä¸è¿”å›ï¼Œæˆ‘æƒ³ä¸­æ–­å®ƒã€‚ä¸€æ—¦å¯¹å…¶è¿›è¡Œä¸­æ–­ï¼Œæ­¤çº¿ç¨‹ä¼šä» <code>LockSupport.park(this);</code> ä¸­å”¤é†’ï¼Œç„¶å <code>Thread.interrupted();</code> è¿”å› trueã€‚</p>
<p>æˆ‘ä»¬å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå³ä½¿æ˜¯ä¸­æ–­å”¤é†’äº†è¿™ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±åªæ˜¯è®¾ç½®äº† <code>interrupted = true</code> ç„¶åç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚è€Œä¸”ï¼Œç”±äº <code>Thread.interrupted();</code>  ä¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œç¬¬äºŒæ¬¡è¿› parkAndCheckInterrupt çš„æ—¶å€™ï¼Œè¿”å›ä¼šæ˜¯ falseã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦çœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œinterrupted åªæ˜¯ç”¨æ¥è®°å½•æ˜¯å¦å‘ç”Ÿäº†ä¸­æ–­ï¼Œç„¶åç”¨äºæ–¹æ³•è¿”å›å€¼ï¼Œå…¶ä»–æ²¡æœ‰åšä»»ä½•ç›¸å…³äº‹æƒ…ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çœ‹å¤–å±‚æ–¹æ³•æ€ä¹ˆå¤„ç† acquireQueued è¿”å› false çš„æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">        selfInterrupt();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selfInterrupt</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread.currentThread().interrupt();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥è¯´ï¼Œlock() æ–¹æ³•å¤„ç†ä¸­æ–­çš„æ–¹æ³•å°±æ˜¯ï¼Œä½ ä¸­æ–­å½’ä¸­æ–­ï¼Œæˆ‘æŠ¢é”è¿˜æ˜¯ç…§æ ·æŠ¢é”ï¼Œå‡ ä¹æ²¡å…³ç³»ï¼Œåªæ˜¯æˆ‘æŠ¢åˆ°é”äº†ä»¥åï¼Œè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è€Œå·²ï¼Œä¹Ÿä¸æŠ›å‡ºä»»ä½•å¼‚å¸¸å‡ºæ¥ã€‚è°ƒç”¨è€…è·å–é”åï¼Œå¯ä»¥å»æ£€æŸ¥æ˜¯å¦å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œä¹Ÿå¯ä»¥ä¸ç†ä¼šã€‚</p>
<hr>
<p>æ¥æ¡åˆ†å‰²çº¿ã€‚æœ‰æ²¡æœ‰è¢«éª—çš„æ„Ÿè§‰ï¼Œæˆ‘è¯´äº†ä¸€å¤§å †ï¼Œå¯æ˜¯å’Œå–æ¶ˆæ²¡æœ‰ä»»ä½•å…³ç³»å•Šã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ ReentrantLock çš„å¦ä¸€ä¸ª lock æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–¹æ³•ä¸Šå¤šäº†ä¸ª <code>throws InterruptedException</code> ï¼Œç»è¿‡å‰é¢é‚£ä¹ˆå¤šçŸ¥è¯†çš„é“ºå«ï¼Œè¿™é‡Œæˆ‘å°±ä¸å†å•°é‡Œå•°å—¦äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></div><div class="line">        <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">    <span class="keyword">if</span> (Thread.interrupted())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</div><div class="line">        doAcquireInterruptibly(arg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»§ç»­å¾€é‡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</div><div class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">final</span> Node p = node.predecessor();</div><div class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</div><div class="line">                setHead(node);</div><div class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></div><div class="line">                failed = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</div><div class="line">                parkAndCheckInterrupt())</div><div class="line">                <span class="comment">// å°±æ˜¯è¿™é‡Œäº†ï¼Œä¸€æ—¦å¼‚å¸¸ï¼Œé©¬ä¸Šç»“æŸè¿™ä¸ªæ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span></div><div class="line">                <span class="comment">// è¿™é‡Œä¸å†åªæ˜¯æ ‡è®°è¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ä»£è¡¨ä¸­æ–­çŠ¶æ€</span></div><div class="line">                <span class="comment">// è€Œæ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸”å¤–å±‚ä¹Ÿä¸æ•è·ï¼Œä¸€ç›´å¾€å¤–æŠ›åˆ° lockInterruptibly</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="comment">// å¦‚æœé€šè¿‡ InterruptedException å¼‚å¸¸å‡ºå»ï¼Œé‚£ä¹ˆ failed å°±æ˜¯ true äº†</span></div><div class="line">        <span class="keyword">if</span> (failed)</div><div class="line">            cancelAcquire(node);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ—¢ç„¶åˆ°è¿™é‡Œäº†ï¼Œé¡ºä¾¿è¯´è¯´ cancelAcquire è¿™ä¸ªæ–¹æ³•å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelAcquire</span><span class="params">(Node node)</span> </span>&#123;</div><div class="line">    <span class="comment">// Ignore if node doesn't exist</span></div><div class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    node.thread = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// Skip cancelled predecessors</span></div><div class="line">    Node pred = node.prev;</div><div class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</div><div class="line">        node.prev = pred = pred.prev;</div><div class="line">    <span class="comment">// predNext is the apparent node to unsplice. CASes below will</span></div><div class="line">    <span class="comment">// fail if not, in which case, we lost race vs another cancel</span></div><div class="line">    <span class="comment">// or signal, so no further action is necessary.</span></div><div class="line">    Node predNext = pred.next;</div><div class="line">    <span class="comment">// Can use unconditional write instead of CAS here.</span></div><div class="line">    <span class="comment">// After this atomic step, other Nodes can skip past us.</span></div><div class="line">    <span class="comment">// Before, we are free of interference from other threads.</span></div><div class="line">    node.waitStatus = Node.CANCELLED;</div><div class="line">    <span class="comment">// If we are the tail, remove ourselves.</span></div><div class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</div><div class="line">        compareAndSetNext(pred, predNext, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// If successor needs signal, try to set pred's next-link</span></div><div class="line">        <span class="comment">// so it will get one. Otherwise wake it up to propagate.</span></div><div class="line">        <span class="keyword">int</span> ws;</div><div class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</div><div class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</div><div class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</div><div class="line">            pred.thread != <span class="keyword">null</span>) &#123;</div><div class="line">            Node next = node.next;</div><div class="line">            <span class="keyword">if</span> (next != <span class="keyword">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</div><div class="line">                compareAndSetNext(pred, predNext, next);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            unparkSuccessor(node);</div><div class="line">        &#125;</div><div class="line">        node.next = node; <span class="comment">// help GC</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘æƒ³æˆ‘åº”è¯¥æŠŠå–æ¶ˆæ’é˜Ÿè¿™ä»¶äº‹è¯´æ¸…æ¥šäº†å§ã€‚</p>
<h2 id="å†è¯´-java-çº¿ç¨‹ä¸­æ–­å’Œ-interruptedexception-å¼‚å¸¸"><a href="#å†è¯´-java-çº¿ç¨‹ä¸­æ–­å’Œ-InterruptedException-å¼‚å¸¸" class="headerlink" title="å†è¯´ java çº¿ç¨‹ä¸­æ–­å’Œ InterruptedException å¼‚å¸¸"></a>å†è¯´ java çº¿ç¨‹ä¸­æ–­å’Œ InterruptedException å¼‚å¸¸</h2><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¥è§¦äº†å¤§é‡çš„ä¸­æ–­ï¼Œè¿™è¾¹ç®—æ˜¯ä¸ªæ€»ç»“å§ã€‚å¦‚æœä½ å®Œå…¨ç†Ÿæ‚‰ä¸­æ–­äº†ï¼Œæ²¡æœ‰å¿…è¦å†çœ‹è¿™èŠ‚ï¼Œæœ¬èŠ‚ä¸ºæ–°æ‰‹è€Œå†™ã€‚</p>
<h3 id="çº¿ç¨‹ä¸­æ–­"><a href="#çº¿ç¨‹ä¸­æ–­" class="headerlink" title="çº¿ç¨‹ä¸­æ–­"></a>çº¿ç¨‹ä¸­æ–­</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œä¸­æ–­ä¸æ˜¯ç±»ä¼¼ linux é‡Œé¢çš„å‘½ä»¤ kill -9 pidï¼Œä¸æ˜¯è¯´æˆ‘ä»¬ä¸­æ–­æŸä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±åœæ­¢è¿è¡Œäº†ã€‚ä¸­æ–­ä»£è¡¨çº¿ç¨‹çŠ¶æ€ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å…³è”äº†ä¸€ä¸ªä¸­æ–­çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ª true æˆ– false çš„ boolean å€¼ï¼Œåˆå§‹å€¼ä¸º falseã€‚</p>
<p>å…³äºä¸­æ–­çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Thread ç±»ä¸­çš„å®ä¾‹æ–¹æ³•ï¼ŒæŒæœ‰çº¿ç¨‹å®ä¾‹å¼•ç”¨å³å¯æ£€æµ‹çº¿ç¨‹ä¸­æ–­çŠ¶æ€</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInterrupted</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// Thread ä¸­çš„é™æ€æ–¹æ³•ï¼Œæ£€æµ‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦å·²ç»ä¸­æ–­</span></div><div class="line"><span class="comment">// æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•è¿”å›ä¸­æ–­çŠ¶æ€çš„åŒæ—¶ï¼Œä¼šå°†æ­¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€é‡ç½®ä¸º false</span></div><div class="line"><span class="comment">// æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¿ç»­è°ƒç”¨ä¸¤æ¬¡è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œç¬¬äºŒæ¬¡çš„è¿”å›å€¼è‚¯å®šå°±æ˜¯ false äº†</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">interrupted</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="comment">// Thread ç±»ä¸­çš„å®ä¾‹æ–¹æ³•ï¼Œç”¨äºè®¾ç½®ä¸€ä¸ªçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º true</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">interrupt</span><span class="params">()</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¯´ä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶å®å°±æ˜¯è®¾ç½®äº†çº¿ç¨‹çš„ interrupted status ä¸º trueï¼Œè‡³äºè¯´è¢«ä¸­æ–­çš„çº¿ç¨‹æ€ä¹ˆå¤„ç†è¿™ä¸ªçŠ¶æ€ï¼Œé‚£æ˜¯é‚£ä¸ªçº¿ç¨‹è‡ªå·±çš„äº‹ã€‚å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (!Thread.interrupted()) &#123;</div><div class="line">   doWork();</div><div class="line">   System.out.println(<span class="string">"æˆ‘åšå®Œä¸€ä»¶äº‹äº†ï¼Œå‡†å¤‡åšä¸‹ä¸€ä»¶ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¸­æ–­æˆ‘çš„è¯"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä¸­æ–­é™¤äº†æ˜¯çº¿ç¨‹çŠ¶æ€å¤–ï¼Œè¿˜æœ‰å…¶ä»–å«ä¹‰ï¼Œå¦åˆ™ä¹Ÿä¸éœ€è¦ä¸“é—¨æä¸€ä¸ªè¿™ä¸ªæ¦‚å¿µå‡ºæ¥äº†ã€‚</p>
<p>å¦‚æœçº¿ç¨‹å¤„äºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼Œé‚£ä¹ˆå½“çº¿ç¨‹è¢«ä¸­æ–­çš„æ—¶å€™ï¼Œèƒ½è‡ªåŠ¨æ„ŸçŸ¥åˆ°ï¼š</p>
<ol>
<li><p>æ¥è‡ª Object ç±»çš„ wait()ã€wait(long)ã€wait(long, int)ï¼Œ</p>
<p>æ¥è‡ª Thread ç±»çš„ join()ã€join(long)ã€join(long, int)ã€sleep(long)ã€sleep(long, int)</p>
<blockquote>
<p>è¿™å‡ ä¸ªæ–¹æ³•çš„ç›¸åŒä¹‹å¤„æ˜¯ï¼Œæ–¹æ³•ä¸Šéƒ½æœ‰: throws InterruptedException </p>
<p>å¦‚æœçº¿ç¨‹é˜»å¡åœ¨è¿™äº›æ–¹æ³•ä¸Šï¼ˆæˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹é˜»å¡ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœå…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªçº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¼šä»è¿™äº›æ–¹æ³•ä¸­ç«‹å³è¿”å›ï¼ŒæŠ›å‡º InterruptedException å¼‚å¸¸ï¼ŒåŒæ—¶é‡ç½®ä¸­æ–­çŠ¶æ€ä¸º falseã€‚</p>
</blockquote>
</li>
<li><p>å®ç°äº† InterruptibleChannel æ¥å£çš„ç±»ä¸­çš„ä¸€äº› I/O é˜»å¡æ“ä½œï¼Œå¦‚ DatagramChannel ä¸­çš„ connect æ–¹æ³•å’Œ receive æ–¹æ³•ç­‰</p>
<blockquote>
<p>å¦‚æœçº¿ç¨‹é˜»å¡åœ¨è¿™é‡Œï¼Œä¸­æ–­çº¿ç¨‹ä¼šå¯¼è‡´è¿™äº›æ–¹æ³•æŠ›å‡º ClosedByInterruptException å¹¶é‡ç½®ä¸­æ–­çŠ¶æ€ã€‚</p>
</blockquote>
</li>
<li><p>Selector ä¸­çš„ select æ–¹æ³•ï¼Œè¿™ä¸ªæœ‰æœºä¼šæˆ‘ä»¬åœ¨è®² NIO çš„æ—¶å€™è¯´</p>
<blockquote>
<p>ä¸€æ—¦ä¸­æ–­ï¼Œæ–¹æ³•ç«‹å³è¿”å›</p>
</blockquote>
</li>
</ol>
<p>å¯¹äºä»¥ä¸Š 3 ç§æƒ…å†µæ˜¯æœ€ç‰¹æ®Šçš„ï¼Œå› ä¸ºä»–ä»¬èƒ½è‡ªåŠ¨æ„ŸçŸ¥åˆ°ä¸­æ–­ï¼ˆè¿™é‡Œè¯´è‡ªåŠ¨ï¼Œå½“ç„¶ä¹Ÿæ˜¯åŸºäºåº•å±‚å®ç°ï¼‰ï¼Œ<strong>å¹¶ä¸”åœ¨åšå‡ºç›¸åº”çš„æ“ä½œåéƒ½ä¼šé‡ç½®ä¸­æ–­çŠ¶æ€ä¸º false</strong>ã€‚</p>
<p>é‚£æ˜¯ä¸æ˜¯åªæœ‰ä»¥ä¸Š 3 ç§æ–¹æ³•èƒ½è‡ªåŠ¨æ„ŸçŸ¥åˆ°ä¸­æ–­å‘¢ï¼Ÿä¸æ˜¯çš„ï¼Œå¦‚æœçº¿ç¨‹é˜»å¡åœ¨ LockSupport.park(Object obj) æ–¹æ³•ï¼Œä¹Ÿå«æŒ‚èµ·ï¼Œè¿™ä¸ªæ—¶å€™çš„ä¸­æ–­ä¹Ÿä¼šå¯¼è‡´çº¿ç¨‹å”¤é†’ï¼Œä½†æ˜¯å”¤é†’åä¸ä¼šé‡ç½®ä¸­æ–­çŠ¶æ€ï¼Œæ‰€ä»¥å”¤é†’åå»æ£€æµ‹ä¸­æ–­çŠ¶æ€å°†æ˜¯ trueã€‚</p>
<h3 id="interruptedexception-æ¦‚è¿°"><a href="#InterruptedException-æ¦‚è¿°" class="headerlink" title="InterruptedException æ¦‚è¿°"></a>InterruptedException æ¦‚è¿°</h3><p>å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¼‚å¸¸ï¼Œä¸æ˜¯è¯´ JVM å¯¹å…¶æœ‰ç‰¹æ®Šçš„å¤„ç†ï¼Œè€Œæ˜¯å®ƒçš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒç‰¹æ®Šã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåƒ Object ä¸­çš„ wait() æ–¹æ³•ï¼ŒReentrantLock ä¸­çš„ lockInterruptibly() æ–¹æ³•ï¼ŒThread ä¸­çš„ sleep() æ–¹æ³•ç­‰ç­‰ï¼Œè¿™äº›æ–¹æ³•éƒ½å¸¦æœ‰ <code>throws InterruptedException</code>ï¼Œæˆ‘ä»¬é€šå¸¸ç§°è¿™äº›æ–¹æ³•ä¸ºé˜»å¡æ–¹æ³•ï¼ˆblocking methodï¼‰ã€‚</p>
<p>é˜»å¡æ–¹æ³•ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ç‰¹å¾æ˜¯ï¼Œå®ƒä»¬éœ€è¦èŠ±è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼ˆä¸æ˜¯ç»å¯¹çš„ï¼Œåªæ˜¯è¯´æ˜æ—¶é—´ä¸å¯æ§ï¼‰ï¼Œè¿˜æœ‰å®ƒä»¬çš„æ–¹æ³•ç»“æŸè¿”å›å¾€å¾€ä¾èµ–äºå¤–éƒ¨æ¡ä»¶ï¼Œå¦‚ wait æ–¹æ³•ä¾èµ–äºå…¶ä»–çº¿ç¨‹çš„ notifyï¼Œlock æ–¹æ³•ä¾èµ–äºå…¶ä»–çº¿ç¨‹çš„ unlockç­‰ç­‰ã€‚</p>
<p>å½“æˆ‘ä»¬çœ‹åˆ°æ–¹æ³•ä¸Šå¸¦æœ‰ <code>throws InterruptedException</code> æ—¶ï¼Œæˆ‘ä»¬å°±è¦çŸ¥é“ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥æ˜¯é˜»å¡æ–¹æ³•ï¼Œæˆ‘ä»¬å¦‚æœå¸Œæœ›å®ƒèƒ½æ—©ç‚¹è¿”å›çš„è¯ï¼Œæˆ‘ä»¬å¾€å¾€å¯ä»¥é€šè¿‡ä¸­æ–­æ¥å®ç°ã€‚ </p>
<p>é™¤äº†å‡ ä¸ªç‰¹æ®Šç±»ï¼ˆå¦‚ Objectï¼ŒThreadç­‰ï¼‰å¤–ï¼Œæ„ŸçŸ¥ä¸­æ–­å¹¶æå‰è¿”å›æ˜¯é€šè¿‡è½®è¯¢ä¸­æ–­çŠ¶æ€æ¥å®ç°çš„ã€‚æˆ‘ä»¬è‡ªå·±éœ€è¦å†™å¯ä¸­æ–­çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡åœ¨åˆé€‚çš„æ—¶æœºï¼ˆé€šå¸¸åœ¨å¾ªç¯çš„å¼€å§‹å¤„ï¼‰å»åˆ¤æ–­çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œç„¶ååšç›¸åº”çš„æ“ä½œï¼ˆé€šå¸¸æ˜¯æ–¹æ³•ç›´æ¥è¿”å›æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬ä¸€æ¬¡å¾ªç¯èŠ±çš„æ—¶é—´æ¯”è¾ƒé•¿çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´æ‰èƒ½æ³¨æ„åˆ°çº¿ç¨‹ä¸­æ–­äº†ã€‚</p>
<h3 id="å¤„ç†ä¸­æ–­"><a href="#å¤„ç†ä¸­æ–­" class="headerlink" title="å¤„ç†ä¸­æ–­"></a>å¤„ç†ä¸­æ–­</h3><p>ä¸€æ—¦ä¸­æ–­å‘ç”Ÿï¼Œæˆ‘ä»¬æ¥æ”¶åˆ°äº†è¿™ä¸ªä¿¡æ¯ï¼Œç„¶åæ€ä¹ˆå»å¤„ç†ä¸­æ–­å‘¢ï¼Ÿæœ¬å°èŠ‚å°†ç®€å•åˆ†æè¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ç»å¸¸ä¼šè¿™ä¹ˆå†™ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Thread.sleep(<span class="number">10000</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    <span class="comment">// ignore</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// go on</span></div></pre></td></tr></table></figure>
<p>å½“ sleep ç»“æŸç»§ç»­å¾€ä¸‹æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€éƒ½ä¸çŸ¥é“è¿™å—ä»£ç æ˜¯çœŸçš„ sleep äº† 10 ç§’ï¼Œè¿˜æ˜¯åªä¼‘çœ äº† 1 ç§’å°±è¢«ä¸­æ–­äº†ã€‚è¿™ä¸ªä»£ç çš„é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå¼‚å¸¸ä¿¡æ¯åæ‰äº†ã€‚ï¼ˆå¯¹äº sleep æ–¹æ³•ï¼Œæˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¸åœ¨æ„æ˜¯å¦æ˜¯ä¸­æ–­äº†ï¼Œè¿™é‡Œæ˜¯ä¸¾ä¾‹ï¼‰</p>
<p>AQS çš„åšæ³•å¾ˆå€¼å¾—æˆ‘ä»¬å€Ÿé‰´ï¼Œæˆ‘ä»¬çŸ¥é“ ReentrantLock æœ‰ä¸¤ç§ lock æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">    sync.lock();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œlock() æ–¹æ³•ä¸å“åº”ä¸­æ–­ã€‚å¦‚æœ thread1 è°ƒç”¨äº† lock() æ–¹æ³•ï¼Œè¿‡äº†å¾ˆä¹…è¿˜æ²¡æŠ¢åˆ°é”ï¼Œè¿™ä¸ªæ—¶å€™ thread2 å¯¹å…¶è¿›è¡Œäº†ä¸­æ–­ï¼Œthread1 æ˜¯ä¸å“åº”è¿™ä¸ªè¯·æ±‚çš„ï¼Œå®ƒä¼šç»§ç»­æŠ¢é”ï¼Œå½“ç„¶å®ƒä¸ä¼šæŠŠâ€œè¢«ä¸­æ–­â€è¿™ä¸ªä¿¡æ¯æ‰”æ‰ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</div><div class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</div><div class="line">        <span class="comment">// æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™é‡Œä¹Ÿæ²¡åšä»»ä½•ç‰¹æ®Šå¤„ç†ï¼Œå°±æ˜¯è®°å½•ä¸‹æ¥ä¸­æ–­çŠ¶æ€ã€‚</span></div><div class="line">        <span class="comment">// è¿™æ ·ï¼Œå¦‚æœå¤–å±‚æ–¹æ³•éœ€è¦å»æ£€æµ‹çš„æ—¶å€™ï¼Œè‡³å°‘æˆ‘ä»¬æ²¡æœ‰æŠŠè¿™ä¸ªä¿¡æ¯ä¸¢äº†</span></div><div class="line">        selfInterrupt();<span class="comment">// Thread.currentThread().interrupt();</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œå¯¹äº lockInterruptibly() æ–¹æ³•ï¼Œå› ä¸ºå…¶æ–¹æ³•ä¸Šé¢æœ‰ <code>throws InterruptedException</code> ï¼Œè¿™ä¸ªä¿¡å·å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦‚æœæˆ‘ä»¬è¦å–æ¶ˆçº¿ç¨‹æŠ¢é”ï¼Œç›´æ¥ä¸­æ–­è¿™ä¸ªçº¿ç¨‹å³å¯ï¼Œå®ƒä¼šç«‹å³è¿”å›ï¼ŒæŠ›å‡º InterruptedException å¼‚å¸¸ã€‚</p>
<p>åœ¨å¹¶å‘åŒ…ä¸­ï¼Œæœ‰éå¸¸å¤šçš„è¿™ç§å¤„ç†ä¸­æ–­çš„ä¾‹å­ï¼Œæä¾›ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºå“åº”ä¸­æ–­å’Œä¸å“åº”ä¸­æ–­ï¼Œå¯¹äºä¸å“åº”ä¸­æ–­çš„æ–¹æ³•ï¼Œè®°å½•ä¸­æ–­è€Œä¸æ˜¯ä¸¢å¤±è¿™ä¸ªä¿¡æ¯ã€‚å¦‚ Condition ä¸­çš„ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">awaitUninterruptibly</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>é€šå¸¸ï¼Œå¦‚æœæ–¹æ³•ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸ï¼Œå¾€å¾€æ–¹æ³•ä½“çš„ç¬¬ä¸€å¥å°±æ˜¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Thread.interrupted())</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line"> 	...... </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>æˆ‘ç›¸ä¿¡ï¼Œæ¸…æ¥šå¹¶ç†Ÿç»ƒä½¿ç”¨ä¸­æ–­ï¼Œå¯¹äºæˆ‘ä»¬å†™å‡ºä¼˜é›…çš„ä»£ç æ˜¯æœ‰å¸®åŠ©çš„ï¼Œä¹Ÿæœ‰åŠ©äºæˆ‘ä»¬åˆ†æåˆ«äººçš„æºç ã€‚</p>
<blockquote>
<p>å‚è€ƒï¼š<a href="https://www.ibm.com/developerworks/library/j-jtp05236/index.html" target="_blank" rel="external">https://www.ibm.com/developerworks/library/j-jtp05236/index.html</a></p>
<p>ç¿»è¯‘ï¼š<a href="https://www.ibm.com/developerworks/cn/java/j-jtp05236.html" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/java/j-jtp05236.html</a></p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™éƒ¨åˆ†å°±ç•™ç€è¯»è€…å§ï¼Œå¸Œæœ›è¯»è€…çœ‹å®Œæœ‰æ‰€æ”¶è·ã€‚</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/05/Threads-And-Locks-md/" rel="next" title="æ·±å…¥åˆ†æ java 8 ç¼–ç¨‹è¯­è¨€è§„èŒƒï¼šThreads and Locks">
                <i class="fa fa-chevron-left"></i> æ·±å…¥åˆ†æ java 8 ç¼–ç¨‹è¯­è¨€è§„èŒƒï¼šThreads and Locks
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/30/AbstractQueuedSynchronizer-3/" rel="prev" title="ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (ä¸‰)">
                ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (ä¸‰) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Hong Jie" />
          <p class="site-author-name" itemprop="name">Hong Jie</p>
           
              <p class="site-description motion-element" itemprop="description">coding is coding.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å…¬å¹³é”å’Œéå…¬å¹³é”"><span class="nav-number">1.</span> <span class="nav-text">å…¬å¹³é”å’Œéå…¬å¹³é”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#condition"><span class="nav-number">2.</span> <span class="nav-text">Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—"><span class="nav-number">2.1.</span> <span class="nav-text">1. å°†èŠ‚ç‚¹åŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-å®Œå…¨é‡Šæ”¾ç‹¬å é”"><span class="nav-number">2.2.</span> <span class="nav-text">2. å®Œå…¨é‡Šæ”¾ç‹¬å é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—"><span class="nav-number">2.3.</span> <span class="nav-text">3. ç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-signal-å”¤é†’çº¿ç¨‹è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—"><span class="nav-number">2.4.</span> <span class="nav-text">4. signal å”¤é†’çº¿ç¨‹ï¼Œè½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€"><span class="nav-number">2.5.</span> <span class="nav-text">5. å”¤é†’åæ£€æŸ¥ä¸­æ–­çŠ¶æ€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-è·å–ç‹¬å é”"><span class="nav-number">2.6.</span> <span class="nav-text">6. è·å–ç‹¬å é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-å¤„ç†ä¸­æ–­çŠ¶æ€"><span class="nav-number">2.7.</span> <span class="nav-text">7. å¤„ç†ä¸­æ–­çŠ¶æ€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¸¦è¶…æ—¶æœºåˆ¶çš„-await"><span class="nav-number">2.8.</span> <span class="nav-text">* å¸¦è¶…æ—¶æœºåˆ¶çš„ await</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸æŠ›å‡º-interruptedexception-çš„-await"><span class="nav-number">2.9.</span> <span class="nav-text">* ä¸æŠ›å‡º InterruptedException çš„ await</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#abstractqueuedsynchronizer-ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ"><span class="nav-number">3.</span> <span class="nav-text">AbstractQueuedSynchronizer ç‹¬å é”çš„å–æ¶ˆæ’é˜Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å†è¯´-java-çº¿ç¨‹ä¸­æ–­å’Œ-interruptedexception-å¼‚å¸¸"><span class="nav-number">4.</span> <span class="nav-text">å†è¯´ java çº¿ç¨‹ä¸­æ–­å’Œ InterruptedException å¼‚å¸¸</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#çº¿ç¨‹ä¸­æ–­"><span class="nav-number">4.1.</span> <span class="nav-text">çº¿ç¨‹ä¸­æ–­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interruptedexception-æ¦‚è¿°"><span class="nav-number">4.2.</span> <span class="nav-text">InterruptedException æ¦‚è¿°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¤„ç†ä¸­æ–­"><span class="nav-number">4.3.</span> <span class="nav-text">å¤„ç†ä¸­æ–­</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">5.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hong Jie</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://javaxiong.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2017/07/20/AbstractQueuedSynchronizer-2/';
          this.page.identifier = '2017/07/20/AbstractQueuedSynchronizer-2/';
          this.page.title = 'ä¸€è¡Œä¸€è¡Œæºç åˆ†ææ¸…æ¥š AbstractQueuedSynchronizer (äºŒ)';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://javaxiong.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
